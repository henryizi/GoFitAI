--- SERVER RESTARTED ---
--- Code version: 2.2 ---
=== API CONFIGURATION ===
Available AI Providers: [ 'openrouter', 'cloudflare', 'fallback' ]
Default AI_PROVIDER: openrouter
Total providers available: 3
- openrouter: ENABLED (deepseek/deepseek-chat)
- cloudflare: ENABLED (@cf/meta/llama-2-7b-chat-int8)
- fallback: ENABLED (rule-based)
========================
Server running on port 4000
Local IP: 192.168.0.100
Server URL: http://192.168.0.100:4000
Test API with: curl http://192.168.0.100:4000/api/test
[FOOD ANALYZE] Received food analysis request
[FOOD ANALYZE] Processing image: foodXXXXXXX.jpg
[FOOD ANALYZE] Error: {
  error: {
    message: 'Input must have at least 1 token.',
    code: 400,
    metadata: { provider_name: null }
  }
}
{"level":30,"time":1755856803662,"pid":3541,"hostname":"MacBook-Air-126.local","req":{"id":1,"method":"POST","url":"/api/analyze-food","query":{},"params":{},"headers":{"host":"192.168.0.100:4000","user-agent":"curl/8.7.1","accept":"*/*","content-length":"14951","content-type":"multipart/form-data; boundary=------------------------gEw1x5XgVhFECHquM6fxUp"},"remoteAddress":"192.168.0.100","remotePort":59349},"res":{"statusCode":500,"headers":{"cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"same-origin","origin-agent-cluster":"?1","referrer-policy":"no-referrer","strict-transport-security":"max-age=15552000; includeSubDomains","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"SAMEORIGIN","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","access-control-allow-origin":"*","access-control-allow-credentials":"true","access-control-expose-headers":"Content-Length,Content-Type","content-type":"application/json; charset=utf-8","content-length":"56","etag":"W/\"38-4DUYe0VRELHYBhRq7+9Gal1WO7E\""}},"err":{"type":"Error","message":"failed with status code 500","stack":"Error: failed with status code 500\n    at onResFinished (/Users/ngkwanho/Desktop/SnapBodyAI/server/node_modules/pino-http/logger.js:114:39)\n    at ServerResponse.onResponseComplete (/Users/ngkwanho/Desktop/SnapBodyAI/server/node_modules/pino-http/logger.js:177:14)\n    at ServerResponse.emit (node:events:530:35)\n    at onFinish (node:_http_outgoing:1081:10)\n    at callback (node:internal/streams/writable:766:21)\n    at afterWrite (node:internal/streams/writable:710:5)\n    at afterWriteTick (node:internal/streams/writable:696:10)\n    at process.processTicksAndRejections (node:internal/process/task_queues:89:21)"},"responseTime":788,"msg":"request errored"}
[2025-08-22T10:05:49.050Z] Test endpoint called
{"level":30,"time":1755857149051,"pid":3541,"hostname":"MacBook-Air-126.local","req":{"id":2,"method":"GET","url":"/api/test","query":{},"params":{},"headers":{"host":"127.0.0.1:4000","user-agent":"curl/8.7.1","accept":"*/*"},"remoteAddress":"127.0.0.1","remotePort":59408},"res":{"statusCode":200,"headers":{"cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"same-origin","origin-agent-cluster":"?1","referrer-policy":"no-referrer","strict-transport-security":"max-age=15552000; includeSubDomains","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"SAMEORIGIN","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","access-control-allow-origin":"*","access-control-allow-credentials":"true","access-control-expose-headers":"Content-Length,Content-Type","content-type":"application/json; charset=utf-8","content-length":"295","etag":"W/\"127-9xiHFjxpGWiU0hG2tAKpnkzAaP4\""}},"responseTime":1,"msg":"request completed"}
[FOOD ANALYZE] Received food analysis request
[FOOD ANALYZE] Processing image: foodXXXXXX.jpg
[FOOD ANALYZE] Error: {
  error: {
    message: 'Input must have at least 1 token.',
    code: 400,
    metadata: { provider_name: null }
  }
}
{"level":30,"time":1755857199816,"pid":3541,"hostname":"MacBook-Air-126.local","req":{"id":3,"method":"POST","url":"/api/analyze-food","query":{},"params":{},"headers":{"host":"127.0.0.1:4000","user-agent":"curl/8.7.1","accept":"*/*","content-length":"14950","content-type":"multipart/form-data; boundary=------------------------AA1DIgH3IlNAQpZvFQ8fZS"},"remoteAddress":"127.0.0.1","remotePort":59415},"res":{"statusCode":500,"headers":{"cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"same-origin","origin-agent-cluster":"?1","referrer-policy":"no-referrer","strict-transport-security":"max-age=15552000; includeSubDomains","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"SAMEORIGIN","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","access-control-allow-origin":"*","access-control-allow-credentials":"true","access-control-expose-headers":"Content-Length,Content-Type","content-type":"application/json; charset=utf-8","content-length":"56","etag":"W/\"38-4DUYe0VRELHYBhRq7+9Gal1WO7E\""}},"err":{"type":"Error","message":"failed with status code 500","stack":"Error: failed with status code 500\n    at onResFinished (/Users/ngkwanho/Desktop/SnapBodyAI/server/node_modules/pino-http/logger.js:114:39)\n    at ServerResponse.onResponseComplete (/Users/ngkwanho/Desktop/SnapBodyAI/server/node_modules/pino-http/logger.js:177:14)\n    at ServerResponse.emit (node:events:530:35)\n    at onFinish (node:_http_outgoing:1081:10)\n    at callback (node:internal/streams/writable:766:21)\n    at afterWrite (node:internal/streams/writable:710:5)\n    at afterWriteTick (node:internal/streams/writable:696:10)\n    at process.processTicksAndRejections (node:internal/process/task_queues:89:21)"},"responseTime":2205,"msg":"request errored"}
[FOOD ANALYZE] Received food analysis request
[FOOD ANALYZE] Processing image: food_XXXXXX.jpg
[FOOD ANALYZE] Error: {
  error: {
    message: 'Input must have at least 1 token.',
    code: 400,
    metadata: { provider_name: null }
  }
}
{"level":30,"time":1755857545682,"pid":3541,"hostname":"MacBook-Air-126.local","req":{"id":4,"method":"POST","url":"/api/analyze-food","query":{},"params":{},"headers":{"host":"127.0.0.1:4000","user-agent":"curl/8.7.1","accept":"*/*","content-length":"225","content-type":"multipart/form-data; boundary=------------------------bdU0hSvMK4YaOzW3sxiGe5"},"remoteAddress":"127.0.0.1","remotePort":59476},"res":{"statusCode":500,"headers":{"cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"same-origin","origin-agent-cluster":"?1","referrer-policy":"no-referrer","strict-transport-security":"max-age=15552000; includeSubDomains","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"SAMEORIGIN","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","access-control-allow-origin":"*","access-control-allow-credentials":"true","access-control-expose-headers":"Content-Length,Content-Type","content-type":"application/json; charset=utf-8","content-length":"56","etag":"W/\"38-4DUYe0VRELHYBhRq7+9Gal1WO7E\""}},"err":{"type":"Error","message":"failed with status code 500","stack":"Error: failed with status code 500\n    at onResFinished (/Users/ngkwanho/Desktop/SnapBodyAI/server/node_modules/pino-http/logger.js:114:39)\n    at ServerResponse.onResponseComplete (/Users/ngkwanho/Desktop/SnapBodyAI/server/node_modules/pino-http/logger.js:177:14)\n    at ServerResponse.emit (node:events:530:35)\n    at onFinish (node:_http_outgoing:1081:10)\n    at callback (node:internal/streams/writable:766:21)\n    at afterWrite (node:internal/streams/writable:710:5)\n    at afterWriteTick (node:internal/streams/writable:696:10)\n    at process.processTicksAndRejections (node:internal/process/task_queues:89:21)"},"responseTime":963,"msg":"request errored"}
[FOOD ANALYZE] Received food analysis request
[FOOD ANALYZE] Processing image: food_XXXXXX.jpgdNcA
[FOOD ANALYZE] Error: {
  error: {
    message: 'Input must have at least 1 token.',
    code: 400,
    metadata: { provider_name: null }
  }
}
{"level":30,"time":1755858280976,"pid":3541,"hostname":"MacBook-Air-126.local","req":{"id":5,"method":"POST","url":"/api/analyze-food","query":{},"params":{},"headers":{"host":"127.0.0.1:4000","user-agent":"curl/8.7.1","accept":"*/*","content-length":"16627","content-type":"multipart/form-data; boundary=------------------------mQNiZMEJANbKGbOpf5aI9W"},"remoteAddress":"127.0.0.1","remotePort":59673},"res":{"statusCode":500,"headers":{"cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"same-origin","origin-agent-cluster":"?1","referrer-policy":"no-referrer","strict-transport-security":"max-age=15552000; includeSubDomains","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"SAMEORIGIN","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","access-control-allow-origin":"*","access-control-allow-credentials":"true","access-control-expose-headers":"Content-Length,Content-Type","content-type":"application/json; charset=utf-8","content-length":"56","etag":"W/\"38-4DUYe0VRELHYBhRq7+9Gal1WO7E\""}},"err":{"type":"Error","message":"failed with status code 500","stack":"Error: failed with status code 500\n    at onResFinished (/Users/ngkwanho/Desktop/SnapBodyAI/server/node_modules/pino-http/logger.js:114:39)\n    at ServerResponse.onResponseComplete (/Users/ngkwanho/Desktop/SnapBodyAI/server/node_modules/pino-http/logger.js:177:14)\n    at ServerResponse.emit (node:events:530:35)\n    at onFinish (node:_http_outgoing:1081:10)\n    at callback (node:internal/streams/writable:766:21)\n    at afterWrite (node:internal/streams/writable:710:5)\n    at afterWriteTick (node:internal/streams/writable:696:10)\n    at process.processTicksAndRejections (node:internal/process/task_queues:89:21)"},"responseTime":1173,"msg":"request errored"}
--- SERVER RESTARTED ---
--- Code version: 2.2 ---
[VISION MODEL DEBUG] CF_VISION_MODEL env var: @cf/llava-1.5-7b-hf
[VISION MODEL DEBUG] Resolved model: @cf/llava-1.5-7b-hf
[VISION MODEL DEBUG] CF_VISION_MODEL env var: @cf/llava-1.5-7b-hf
[VISION MODEL DEBUG] Resolved model: @cf/llava-1.5-7b-hf
=== API CONFIGURATION ===
DeepSeek-only mode: DISABLED
Strict mode (effective): DISABLED
Available AI Providers: [ 'deepseek', 'cloudflare', 'fallback' ]
Default AI_PROVIDER: openrouter
Total providers available: 3
- deepseek: ENABLED (deepseek-chat)
- cloudflare: ENABLED (@cf/llava-1.5-7b-hf)
- fallback: ENABLED (rule-based)
========================
Server running on port 4000
Local IP: 192.168.0.100
Server URL: http://192.168.0.100:4000
Test API with: curl http://192.168.0.100:4000/api/test
--- SERVER RESTARTED ---
--- Code version: 2.2 ---
[VISION MODEL DEBUG] CF_VISION_MODEL env var: @cf/llava-1.5-7b-hf
[VISION MODEL DEBUG] Resolved model: @cf/llava-1.5-7b-hf
[VISION MODEL DEBUG] CF_VISION_MODEL env var: @cf/llava-1.5-7b-hf
[VISION MODEL DEBUG] Resolved model: @cf/llava-1.5-7b-hf
=== API CONFIGURATION ===
DeepSeek-only mode: DISABLED
Strict mode (effective): DISABLED
Available AI Providers: [ 'deepseek', 'cloudflare', 'fallback' ]
Default AI_PROVIDER: openrouter
Total providers available: 3
- deepseek: ENABLED (deepseek-chat)
- cloudflare: ENABLED (@cf/llava-1.5-7b-hf)
- fallback: ENABLED (rule-based)
========================
Server running on port 4000
Local IP: 192.168.0.100
Server URL: http://192.168.0.100:4000
Test API with: curl http://192.168.0.100:4000/api/test
--- SERVER RESTARTED ---
--- Code version: 2.2 ---
[VISION MODEL DEBUG] CF_VISION_MODEL env var: @cf/llava-1.5-7b-hf
[VISION MODEL DEBUG] Resolved model: @cf/llava-1.5-7b-hf
[VISION MODEL DEBUG] CF_VISION_MODEL env var: @cf/llava-1.5-7b-hf
[VISION MODEL DEBUG] Resolved model: @cf/llava-1.5-7b-hf
=== API CONFIGURATION ===
DeepSeek-only mode: DISABLED
Strict mode (effective): DISABLED
Available AI Providers: [ 'deepseek', 'cloudflare', 'fallback' ]
Default AI_PROVIDER: openrouter
Total providers available: 3
- deepseek: ENABLED (deepseek-chat)
- cloudflare: ENABLED (@cf/llava-1.5-7b-hf)
- fallback: ENABLED (rule-based)
========================
Server running on port 4000
Local IP: 192.168.0.100
Server URL: http://192.168.0.100:4000
Test API with: curl http://192.168.0.100:4000/api/test
[MULTER] Uploaded file details: { originalname: 'apple.png', mimetype: 'image/png', size: undefined }
[MULTER] File accepted: apple.png
[FOOD ANALYZE] Received food analysis request
[FOOD ANALYZE] Request details: {
  hasFile: true,
  hasDescription: false,
  fileInfo: {
    originalname: 'apple.png',
    filename: '0a4074fd20df8fd11fb1eb4029956465',
    mimetype: 'image/png',
    size: 12285
  }
}
[FOOD ANALYZE] Processing uploaded image: apple.png
[FOOD ANALYZE] Using vision AI to analyze food image
[FOOD ANALYZE] Image size: 16380 characters
[FOOD ANALYZE] MIME type: image/png
[FOOD ANALYZE] Calling vision AI service with model: @cf/llava-1.5-7b-hf
[FOOD ANALYZE] Cloudflare Debug Info:
- CF_ACCOUNT_ID length: 40
- CF_API_TOKEN length: 40
- CF_VISION_MODEL: @cf/llava-1.5-7b-hf
[FOOD ANALYZE] DeepSeek does not support vision - using Cloudflare for image analysis
[FOOD ANALYZE] Using vision model: @cf/llava-1.5-7b-hf
[FOOD ANALYZE] Standardizing image for tensor processing
[IMAGE STANDARDIZE] Standardizing image for tensor processing
[IMAGE VALIDATE] Image passed validation
[IMAGE STANDARDIZE] Original: {
  format: 'gif',
  width: 100,
  height: 100,
  channels: 3,
  density: undefined
}
[IMAGE STANDARDIZE] Standardized: {
  format: 'jpeg',
  width: 100,
  height: 100,
  channels: 3,
  sizeBytes: 1814
}
[FOOD ANALYZE] Image standardized, new size: 2420
[FOOD ANALYZE] Using LLaVA request format
[FOOD ANALYZE] Making Cloudflare API call to: https://api.cloudflare.com/client/v4/accounts/rejC3Pshc9GsXT5ZzQq9PoQbD0J0hM5bgAWuETWw/ai/run/@cf/llava-1.5-7b-hf
[FOOD ANALYZE] Cloudflare URL details: {
  accountIdLength: 40,
  modelSlug: '@cf/llava-1.5-7b-hf',
  modelSlugLength: 19
}
[FOOD ANALYZE] Request body keys: [ 'messages', 'max_tokens' ]
[FOOD ANALYZE] Vision analysis failed: Request failed with status code 404
[FOOD ANALYZE] Vision error details: {
  status: 404,
  statusText: 'Not found',
  data: { result: null, success: false, errors: [ [Object] ], messages: [] },
  headers: Object [AxiosHeaders] {
    date: 'Tue, 26 Aug 2025 03:54:48 GMT',
    'content-type': 'application/json',
    'transfer-encoding': 'chunked',
    connection: 'keep-alive',
    'api-version': '2025-08-26',
    'cf-auditlog-id': '0198e483-a214-74f5-bc01-dbff41295b1a',
    'set-cookie': [
      '__cf_bm=keHRh3Jkw9Ebcjs88qMAXyDmhtz9mUk8KL3XDTB58qI-1756180488-1.0.1.1-tNz7DvgtNSIs3etZdWPzFdTulZM.2h7IS88Gjf3njXcqL7thUJvI9VHyoKoqXdGccmkWj01qEFo1yEV.dtQ8zHJrjSHApLG7ahGqF1EntcY; path=/; expires=Tue, 26-Aug-25 04:24:48 GMT; domain=.api.cloudflare.com; HttpOnly; Secure; SameSite=None',
      '_cfuvid=hiNOLP9dvMGddIZN9d3PXdLtqFRz1qDY7CQNsI7R3ng-1756180488730-0.0.1.1-604800000; path=/; domain=.api.cloudflare.com; HttpOnly; Secure; SameSite=None'
    ],
    vary: 'Accept-Encoding',
    server: 'cloudflare',
    'cf-ray': '975063d66d81a927-DFW'
  }
}
{"level":30,"time":1756180488792,"pid":64854,"hostname":"MacBook-Air-126.local","req":{"id":1,"method":"POST","url":"/api/analyze-food","query":{},"params":{},"headers":{"host":"127.0.0.1:4000","user-agent":"curl/8.7.1","accept":"*/*","content-length":"12488","content-type":"multipart/form-data; boundary=------------------------q8hdIg23noJ4H3e5Q9lPc2"},"remoteAddress":"127.0.0.1","remotePort":63915},"res":{"statusCode":200,"headers":{"cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"same-origin","origin-agent-cluster":"?1","referrer-policy":"no-referrer","strict-transport-security":"max-age=15552000; includeSubDomains","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"SAMEORIGIN","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","access-control-allow-origin":"*","access-control-allow-credentials":"true","access-control-expose-headers":"Content-Length,Content-Type","content-type":"application/json; charset=utf-8","content-length":"393","etag":"W/\"189-chhJHR1b9awR6s8enBirDF9Xn0I\""}},"responseTime":849,"msg":"request completed"}
