# üçé Apple Sign-In Troubleshooting Guide

## Current Status
- ‚úÖ All integration tests passing (100% success rate)
- ‚úÖ JWT token generated successfully
- ‚ùå "Authorization attempt failed for an unknown reason" error in app

## Step-by-Step Debugging Process

### 1. üîç Check Console Logs
With the enhanced debugging now added to `SocialAuthService.ts`, when you test Apple Sign-In, you should see detailed logs like:

```
üçé Starting Apple Sign-In process...
üçé Apple Sign-In availability: true
üçé Requesting Apple ID credential...
üçé Apple credential received: { user: "...", email: "...", ... }
üçé Signing in with Supabase using Apple ID token...
üçé Supabase response: { hasData: true, hasUser: true, ... }
```

**Look for where the process stops or shows an error.**

### 2. üîß Supabase Configuration Checklist

#### Required Supabase Settings:
1. **Go to Supabase Dashboard ‚Üí Authentication ‚Üí Providers ‚Üí Apple**
2. **Enable Apple Provider**: ‚úÖ Toggle should be ON
3. **Client ID**: `com.henrymadeit.gofitai.signin` (Services ID, NOT Bundle ID)
4. **Secret Key**: Use the JWT token generated by our script:
   ```
   eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IjdMR0FKUDlDN1cifQ.eyJpc3MiOiJWSk1DTUQ1TlNIIiwiaWF0IjoxNzYxOTkzMjUyLCJleHAiOjE3Nzc1NDUyNTIsImF1ZCI6Imh0dHBzOi8vYXBwbGVpZC5hcHBsZS5jb20iLCJzdWIiOiJjb20uaGVucnltYWRlaXQuZ29maXRhaS5zaWduaW4ifQ.T8iwJGL_l87xR5cmUtr66KpkJXx5-lpU50tsP2geK_yoKvE8N6UVYasnLn9s0BleMUieM9Qv1305rQ4gWximuQ
   ```

#### ‚ö†Ô∏è Common Configuration Mistakes:
- Using Bundle ID (`com.henrymadeit.gofitai`) instead of Services ID (`com.henrymadeit.gofitai.signin`)
- Expired or incorrectly generated JWT token
- Apple provider not enabled in Supabase
- Wrong redirect URLs

### 3. üèóÔ∏è Apple Developer Console Verification

#### Check Apple Developer Settings:
1. **App ID**: `com.henrymadeit.gofitai`
   - ‚úÖ Sign In with Apple capability enabled
2. **Services ID**: `com.henrymadeit.gofitai.signin`
   - ‚úÖ Configured and enabled
   - ‚úÖ Return URLs configured for Supabase
3. **Key**: `AuthKey_7LGAJP9C7W.p8`
   - ‚úÖ Downloaded and present in project

### 4. üîÑ Test Different Scenarios

#### A. Test Apple Authentication Directly
```javascript
// In your app, try this minimal test:
import * as AppleAuthentication from 'expo-apple-authentication';

const testAppleAuth = async () => {
  try {
    const credential = await AppleAuthentication.signInAsync({
      requestedScopes: [
        AppleAuthentication.AppleAuthenticationScope.FULL_NAME,
        AppleAuthentication.AppleAuthenticationScope.EMAIL,
      ],
    });
    console.log('‚úÖ Apple credential received:', credential);
  } catch (error) {
    console.log('‚ùå Apple auth failed:', error);
  }
};
```

#### B. Test Supabase Connection
```javascript
// Test if Supabase is reachable:
const testSupabase = async () => {
  try {
    const { data, error } = await supabase.auth.getSession();
    console.log('‚úÖ Supabase connection:', { data, error });
  } catch (error) {
    console.log('‚ùå Supabase connection failed:', error);
  }
};
```

### 5. üö® Common Error Scenarios

#### "Authorization attempt failed for an unknown reason"
This error typically occurs at one of these points:

1. **Apple Authentication Level** (before Supabase):
   - Invalid Apple Developer configuration
   - Missing or incorrect entitlements
   - App not properly signed

2. **Supabase Integration Level**:
   - Apple provider not configured in Supabase
   - Invalid JWT secret key
   - Wrong Client ID in Supabase

3. **Network/Environment Level**:
   - Network connectivity issues
   - Simulator vs. device differences
   - Development vs. production environment

### 6. üîß Immediate Action Items

1. **Enable Debug Logging**: The enhanced logging is now active
2. **Verify Supabase Config**: Double-check all Apple provider settings
3. **Test on Physical Device**: Apple Sign-In behaves differently on simulator vs. device
4. **Check Network**: Ensure stable internet connection
5. **Regenerate JWT**: If token is old, generate a fresh one

### 7. üì± Testing Instructions

1. **Run the app** with the new debug logging
2. **Tap "Continue with Apple"**
3. **Check the console logs** for detailed error information
4. **Share the console output** to identify exactly where the failure occurs

### 8. üÜò If Still Failing

If the issue persists after checking all above:

1. **Share console logs** from the debug output
2. **Verify Supabase dashboard** shows Apple provider as enabled
3. **Test with a fresh Supabase project** to isolate configuration issues
4. **Check Apple Developer Console** for any warnings or errors

---

## Quick Commands

Generate fresh JWT token:
```bash
node scripts/generate-apple-jwt.js
```

Test integration:
```bash
node scripts/test-apple-signin-integration.js
```

## Key Configuration Values

- **Bundle ID**: `com.henrymadeit.gofitai`
- **Services ID**: `com.henrymadeit.gofitai.signin`
- **Team ID**: `VJMCMD5NSH`
- **Key ID**: `7LGAJP9C7W`
- **Private Key**: `AuthKey_7LGAJP9C7W.p8`





